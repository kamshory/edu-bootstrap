function renderLatex(latex){let equgen=document.getElementById("renderer").value,urlGenerator=window.parent.equationURLGenerator||"../cgi-bin/equgen.cgi",urlPreview=window.parent.equationURLPreview||"../cgi-bin/equgen.cgi";if("server"==equgen)if(latex.length>0){let equationURL=urlPreview+"?"+latex,img=document.createElement("img");img.src=equationURL,img.setAttribute("alt",latex),img.setAttribute("data-latex",latex),img.setAttribute("class","latex-image"),img.style.verticalAlign="middle";let html=img.outerHTML;document.getElementById("image-container").innerHTML=html}else document.getElementById("image-container").innerHTML="";else{let svg=asciimath.latexToSVG(latex),url="data:image/svg+xml;base64,"+Base64.encode(svg),img=document.createElement("img");img.src=url,img.setAttribute("alt",latex),img.setAttribute("data-latex",latex),img.setAttribute("class","latex-image"),img.style.verticalAlign="middle";let html=img.outerHTML;document.getElementById("image-container").innerHTML=html}}function decodeLatexFromURI(data){return data.indexOf("#latex%7C")>-1&&(data=data.substr(data.indexOf("#latex%7C")+9),data=decodeURIComponent(data)),data}function handlePasteImage(e){let data="";if(e&&e.clipboardData&&e.clipboardData.getData)if(/text\/html/.test(e.clipboardData.types)){data=e.clipboardData.getData("text/plain");try{data=asciimath.reconstructSqrtWord(data),data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),e.clipboardData.setData("text/html",data),document.getElementById("latex-input").value=data}catch(e){data=asciimath.reconstructSqrtWord(data),data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data),document.getElementById("latex-input").value=data}e.preventDefault&&(e.stopPropagation(),e.preventDefault())}else data=e.clipboardData.getData("text/plain"),data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),setTimeout((function(){""!=data&&(document.getElementById("latex-input").value=data)}),10),renderLatex(data)}window.onload=function(e){let equgen=window.parent.equationRenderer||"browser";document.getElementById("renderer").value=equgen,document.getElementById("renderer").addEventListener("change",(function(e){let data=document.getElementById("latex-input").value;data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data)})),document.getElementById("latex-input").addEventListener("change",(function(e){let data=e.target.value;data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data)})),document.getElementById("latex-input").addEventListener("keyup",(function(e){let data=e.target.value;data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data)})),document.getElementById("latex-input").addEventListener("blur",(function(e){let data=e.target.value;data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data)})),document.getElementById("latex-input").addEventListener("focus",(function(e){let data=e.target.value;data=asciimath.filterData(data),data=asciimath.reconstructMatrix(data),data=asciimath.reconstructVector(data),renderLatex(data)})),document.getElementById("latex-input").addEventListener("paste",handlePasteImage);let url=document.location.toString(),data;if(url.indexOf("arg=")>-1){let textSelected=url.substr(url.indexOf("arg=")+4);textSelected=decodeURIComponent(textSelected),textSelected=textSelected.trim(),0===textSelected.indexOf("$$")&&(textSelected=textSelected.substr(2)),"$$"==textSelected.substr(textSelected.length-2,2)&&(textSelected=textSelected.substr(0,textSelected.length-2)),textSelected=decodeLatexFromURI(textSelected),textSelected=asciimath.reconstructSqrtWord(textSelected),textSelected=asciimath.filterData(textSelected),textSelected=asciimath.reconstructMatrix(textSelected),textSelected=asciimath.reconstructVector(textSelected),document.getElementById("latex-input").value=textSelected}document.getElementById("latex-input").focus(),renderLatex(document.getElementById("latex-input").value)};let generatePNG=!0;function insertEquation(includeLatex){let latex=document.getElementById("latex-input").value,equgen=document.getElementById("renderer").value;if("server-png"==equgen){if(latex.length>0){latex=asciimath.reconstructSqrtWord(latex),latex=asciimath.filterData(latex),latex=asciimath.reconstructMatrix(latex),latex=asciimath.reconstructVector(latex);let urlGenerator=window.parent.equationURLGenerator||"../cgi-bin/equgen.cgi",urlPreview=window.parent.equationURLPreview||"../cgi-bin/equgen.cgi",url=urlGenerator+"?"+latex,img=new Image,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");img.onload=function(){canvas.setAttribute("width",img.width),canvas.setAttribute("height",img.height),ctx.drawImage(img,0,0);let dataURL=canvas.toDataURL("png");includeLatex?window.parent.uploadBase64ImageFromLatex(dataURL,2,"png","latex|"+latex):window.parent.uploadBase64ImageFromLatex(dataURL,2,"png")},img.src=url}}else if("browser-mathml"==equgen){let data=asciimath.latexToSVG(latex,!0,!0);includeLatex?window.parent.uploadBase64ImageFromLatex("data:image/svg+xml;base64,"+Base64.encode(data),2,"svg","latex|"+latex):window.parent.uploadBase64ImageFromLatex("data:image/svg+xml;base64,"+Base64.encode(data),2,"svg")}else{let data=asciimath.latexToSVG(latex,!0,!0),DOMURL=window.URL||window.webkitURL||window,img=new Image,svg=new Blob([data],{type:"image/svg+xml"}),url=DOMURL.createObjectURL(svg),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d");img.onload=function(){canvas.setAttribute("width",img.width),canvas.setAttribute("height",img.height),ctx.drawImage(img,0,0),DOMURL.revokeObjectURL(url),includeLatex?window.parent.uploadBase64ImageFromLatex(canvas.toDataURL("png"),2,"png","latex|"+latex):window.parent.uploadBase64ImageFromLatex(canvas.toDataURL("png"),2,"png")},img.src=url}}