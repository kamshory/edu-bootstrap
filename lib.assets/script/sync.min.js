let fileSyncFilesDownload={},fileUserFilesDownload={},fileSyncFilesUpload={},fileUserFilesUpload={},databaseSyncFilesDownload={},databaseUserFilesDownload={},databaseSyncFilesUpload={},syncPath="";function startSync(path,clbk){syncPath=path,fileDownloadInformation(clbk)}function getFileSyncId(source){if(source.recordList.length>0)for(let i in source.recordList)if(!source.recordList[i].executed)return source.recordList[i].recordId;return null}function updateRecordStatus(source,recordId){if(source.recordList.length>0)for(let i in source.recordList)source.recordList[i].recordId==recordId&&(source.recordList[i].executed=!0)}function updateProgressBar(type,direction,step,value){let percent=0;if("object"==typeof value){let list=value,all=list.length,val=0;for(let i in list)list[i].executed&&val++;percent=all>0?100*val/all:100}else percent=value;let selector,pb=$('.sync-item[data-type="'+type+'"][data-direction="'+direction+'"][data-step="'+step+'"]').find(".progress-bar");pb.css({width:percent+"%"}),pb.attr("aria-valuenow",percent)}function fileDownloadInformation(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"down",step:1},type:"GET",dataType:"json",success:function(response){response.success&&response.completed&&(filePrepareDownloadSyncFiles(clbk),updateProgressBar("file","down",1,100))}})}function filePrepareDownloadSyncFiles(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"down",step:2},type:"GET",dataType:"json",success:function(response){if(response.success){fileSyncFilesDownload.recordList=response.recordList;let recordId=getFileSyncId(fileSyncFilesDownload);null!=recordId?fileDownloadSyncFiles(recordId,clbk):(updateProgressBar("file","down",3,100),filePrepareDownloadUserFiles(clbk))}}})}function fileDownloadSyncFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"file",direction:"down",step:3,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(fileSyncFilesDownload,recordId),updateProgressBar("file","down",3,fileSyncFilesDownload.recordList);let nextRecordId=getFileSyncId(fileSyncFilesDownload);null!=nextRecordId?fileDownloadSyncFiles(nextRecordId,clbk):filePrepareDownloadUserFiles(clbk)}}})}function filePrepareDownloadUserFiles(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"down",step:4},type:"GET",dataType:"json",success:function(response){if(response.success){fileUserFilesDownload.recordList=response.recordList;let recordId=getFileSyncId(fileUserFilesDownload);null!=recordId?fileDownloadUserFiles(recordId,clbk):(updateProgressBar("file","down",5,100),fileUploadPreparation(clbk))}}})}function fileDownloadUserFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"file",direction:"down",step:5,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(fileUserFilesDownload,recordId),updateProgressBar("file","down",5,fileUserFilesDownload.recordList);let nextRecordId=getFileSyncId(fileUserFilesDownload);null!=nextRecordId?fileDownloadUserFiles(nextRecordId,clbk):fileUploadPreparation(clbk)}}})}function fileUploadPreparation(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:1},type:"GET",dataType:"json",success:function(response){response.success&&(updateProgressBar("file","up",1,100),filePrepareUploadUserFiles(clbk))}})}function filePrepareUploadUserFiles(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:2},type:"GET",dataType:"json",success:function(response){if(response.success){fileSyncFilesUpload.recordList=response.recordList;let recordId=getFileSyncId(fileSyncFilesUpload);null!=recordId?fileUploadUserFiles(recordId,clbk):(updateProgressBar("file","up",3,100),filePrepareUploadSyncFiles(clbk))}}})}function fileUploadUserFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:3,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(fileSyncFilesUpload,recordId),updateProgressBar("file","up",3,fileSyncFilesUpload.recordList);let nextRecordId=getFileSyncId(fileSyncFilesUpload);null!=nextRecordId?fileUploadUserFiles(nextRecordId,clbk):filePrepareUploadSyncFiles(clbk)}}})}function filePrepareUploadSyncFiles(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:4},type:"GET",dataType:"json",success:function(response){if(response.success){fileUserFilesUpload.recordList=response.recordList;let recordId=getFileSyncId(fileUserFilesUpload);null!=recordId?fileUploadSyncFiles(recordId,clbk):(updateProgressBar("file","up",5,100),fileUploadInformation(clbk))}}})}function fileUploadSyncFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:5,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(fileUserFilesUpload,recordId),updateProgressBar("file","up",5,fileUserFilesUpload.recordList);let nextRecordId=getFileSyncId(fileUserFilesUpload);null!=nextRecordId?fileUploadSyncFiles(nextRecordId,clbk):fileUploadInformation(clbk)}}})}function fileUploadInformation(clbk){$.ajax({url:syncPath,data:{type:"file",direction:"up",step:6},type:"GET",dataType:"json",success:function(response){response.success&&(updateProgressBar("file","up",7,100),databaseDownloadInformation(clbk))}})}function databaseDownloadInformation(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"down",step:1},type:"GET",dataType:"json",success:function(response){response.success&&response.completed&&(databasePrepareDownloadSyncFiles(clbk),updateProgressBar("database","down",1,100))}})}function databasePrepareDownloadSyncFiles(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"down",step:2},type:"GET",dataType:"json",success:function(response){if(response.success){databaseSyncFilesDownload.recordList=response.recordList;let recordId=getFileSyncId(databaseSyncFilesDownload,clbk);null!=recordId?databaseDownloadSyncFiles(recordId,clbk):(updateProgressBar("database","down",3,100),databasePrepareExecuteQuery(clbk))}}})}function databaseDownloadSyncFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"database",direction:"down",step:3,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(databaseSyncFilesDownload,recordId),updateProgressBar("database","down",3,databaseSyncFilesDownload.recordList);let nextRecordId=getFileSyncId(databaseSyncFilesDownload);null!=nextRecordId?databaseDownloadSyncFiles(nextRecordId,clbk):databasePrepareExecuteQuery(clbk)}}})}function databasePrepareExecuteQuery(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"down",step:4},type:"GET",dataType:"json",success:function(response){if(response.success){databaseSyncFilesDownload.recordList=response.recordList;let recordId=getFileSyncId(databaseSyncFilesDownload);null!=recordId?databaseExecuteQuery(recordId,clbk):(updateProgressBar("database","down",5,100),databaseUploadPreparation(clbk))}}})}function databaseExecuteQuery(recordId,clbk){$.ajax({url:syncPath,data:{type:"database",direction:"down",step:5,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(databaseSyncFilesDownload,recordId),updateProgressBar("database","down",5,databaseSyncFilesDownload.recordList);let nextRecordId=getFileSyncId(databaseSyncFilesDownload);null!=nextRecordId?databaseExecuteQuery(nextRecordId,clbk):databaseUploadPreparation(clbk)}}})}function databaseUploadPreparation(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"up",step:1},type:"GET",dataType:"json",success:function(response){response.success&&(updateProgressBar("database","up",1,100),databasePrepareUploadSyncFiles(clbk))}})}function databasePrepareUploadSyncFiles(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"up",step:2},type:"GET",dataType:"json",success:function(response){if(response.success){databaseSyncFilesUpload.recordList=response.recordList;let recordId=getFileSyncId(databaseSyncFilesUpload);null!=recordId?databaseUploadSyncFiles(recordId,clbk):(updateProgressBar("database","up",3,100),databaseUploadInformation(clbk))}}})}function databaseUploadSyncFiles(recordId,clbk){$.ajax({url:syncPath,data:{type:"database",direction:"up",step:3,recordId:recordId},type:"GET",dataType:"json",success:function(response){if(response.success){updateRecordStatus(databaseSyncFilesUpload,recordId),updateProgressBar("database","up",3,databaseSyncFilesUpload.recordList);let nextRecordId=getFileSyncId(databaseSyncFilesUpload);null!=nextRecordId?databaseUploadSyncFiles(nextRecordId,clbk):databaseUploadInformation(clbk)}}})}function databaseUploadInformation(clbk){$.ajax({url:syncPath,data:{type:"database",direction:"up",step:4},type:"GET",dataType:"json",success:function(response){response.success&&(updateProgressBar("database","up",5,100),clbk())}})}